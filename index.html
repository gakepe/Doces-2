<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor de Lista de Sabores</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #f0f0f0;
      margin: 0;
      overflow-x: hidden;
    }
    /* Container principal com margin-top para empurrar tudo para baixo */
    #container-principal {
      margin-top: 3000px;
      padding: 20px;
    }
    h2 {
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e1e1e;
    }
    th, td {
      border: 1px solid #333;
      padding: 10px;
      text-align: center;
      min-width: 80px;
      color: #f0f0f0;
    }
    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
      border: 2px solid white;
      border-radius: 4px;
      background-color: #121212;
      color: white;
    }
    input::placeholder, select option {
      color: #ccc;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #64b5f6;
      box-shadow: 0 0 5px #64b5f6;
    }
    button {
      background-color: #2196f3;
      color: white;
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #1976d2;
    }
    .botoes-embaixo {
      margin-top: 10px;
    }
    .botoes-embaixo button {
      width: 48%;
      display: inline-block;
      margin: 1%;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c2c2c;
      padding: 20px;
      border-radius: 10px;
      display: none;
      z-index: 2000;
      box-shadow: 0 0 15px rgba(0,0,0,0.6);
      min-width: 320px;
    }
    .popup button {
      width: 48%;
      display: inline-block;
      margin: 1% 1% 0 1%;
    }
    #popupAdicionarPeso button {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div id="container-principal">
    <h2>Editor de Lista de Sabores</h2>

    <button onclick="mostrarPopup('popupAdicionarPeso')">Adicionar Peso</button>

    <div class="botoes-embaixo">
      <button onclick="mostrarPopup('novaColunaPopup')">Adicionar Nova Coluna</button>
      <button onclick="mostrarPopup('removerColunaPopup')">Remover Coluna</button>
      <button onclick="mostrarPopup('adicionarDocePopup')">Adicionar Doce</button>
      <button onclick="mostrarPopup('removerDocePopup')">Remover Doce</button>
      <button onclick="baixarPNG(true)">Baixar PNG</button>
      <button onclick="mostrarPopup('salvarPopup')">Salvar no OneDrive</button>
    </div>

    <br><br>

    <table id="tabela">
      <thead>
        <tr><th>N</th><th>Produto</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- POPUPS -->

  <div id="popupAdicionarPeso" class="popup">
    <input type="text" id="buscaDoce" placeholder="Buscar doce...">
    <select id="produtoSelect"></select>
    <select id="colunaSelect"></select>
    <input type="text" id="campoPeso" placeholder="Peso (ex: 0.250)">
    <button onclick="adicionarQuantidade()">Adicionar Peso</button>
    <button onclick="somarPeso()">Somar Peso</button>
    <button onclick="adicionarZeros()">Adicionar 0</button>
    <button onclick="limparPesosConfirm()">Limpar Pesos</button>
    <button onclick="fecharPopup('popupAdicionarPeso')">Fechar</button>
  </div>

  <div id="novaColunaPopup" class="popup">
    <input type="number" id="numeroColuna" placeholder="Número da nova coluna">
    <button onclick="adicionarColunaConfirmado()">Confirmar</button>
    <button onclick="fecharPopup('novaColunaPopup')">Fechar</button>
  </div>

  <div id="removerColunaPopup" class="popup">
    <select id="colunaRemover"></select>
    <button onclick="removerColunaConfirmado()">Confirmar</button>
    <button onclick="fecharPopup('removerColunaPopup')">Fechar</button>
  </div>

  <div id="adicionarDocePopup" class="popup">
    <input type="text" id="nomeNovoDoce" placeholder="Nome do novo doce">
    <button onclick="adicionarLinhaConfirmado()">Adicionar</button>
    <button onclick="fecharPopup('adicionarDocePopup')">Fechar</button>
  </div>

  <div id="removerDocePopup" class="popup">
    <input type="text" id="buscaRemover" placeholder="Buscar doce...">
    <select id="listaRemover"></select>
    <button onclick="removerDoceConfirmado()">Remover</button>
    <button onclick="fecharPopup('removerDocePopup')">Fechar</button>
  </div>

  <div id="salvarPopup" class="popup">
    <button onclick="exportarDados()">Exportar Dados</button>
    <input type="file" id="importarArquivo" accept=".json" style="display:none" onchange="importarDados(event)">
    <button onclick="abrirSeletorImportacao()">Importar Dados</button>
    <button onclick="fecharPopup('salvarPopup')">Fechar</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
// ===== VARIÁVEIS GLOBAIS =====
let listaDoces = [];
let totalColunas = 1;

// ===== INICIALIZAÇÃO =====
document.addEventListener("DOMContentLoaded", () => {
  carregarDoLocalStorage();
  atualizarDropdowns();
  atualizarTabela();

  // Eventos de filtro dos selects dentro do popup adicionar peso
  document.getElementById("buscaDoce").addEventListener("input", filtrarDropdown);
  document.getElementById("buscaRemover").addEventListener("input", filtrarDropdownRemover);

  // Evento para inserir ponto automaticamente no campo peso
  const campoPeso = document.getElementById("campoPeso");
  campoPeso.addEventListener("input", function(e) {
    let val = this.value;
    if (val.length === 1 && /\d/.test(val) && !val.includes(".")) {
      this.value = val + ".";
    }
  });
});

// ===== ATUALIZAÇÃO DE INTERFACE =====
function atualizarDropdowns() {
  const produtoSelect = document.getElementById("produtoSelect");
  const colunaSelect = document.getElementById("colunaSelect");
  const removerSelect = document.getElementById("listaRemover");
  const colunaRemover = document.getElementById("colunaRemover");

  produtoSelect.innerHTML = "";
  removerSelect.innerHTML = "";

  // Ordenar nomes
  const nomesOrdenados = [...listaDoces.map(doc => doc.nome)].sort();
  nomesOrdenados.forEach(nome => {
    const opt = document.createElement("option");
    opt.value = opt.text = nome;
    produtoSelect.appendChild(opt);

    const opt2 = document.createElement("option");
    opt2.value = opt2.text = nome;
    removerSelect.appendChild(opt2);
  });

  colunaSelect.innerHTML = "";
  colunaRemover.innerHTML = "";
  for (let i = 1; i <= totalColunas; i++) {
    const opt = document.createElement("option");
    opt.value = opt.text = "Q" + i;
    colunaSelect.appendChild(opt);

    const opt2 = document.createElement("option");
    opt2.value = opt2.text = "Q" + i;
    colunaRemover.appendChild(opt2.cloneNode(true));
  }
}

function atualizarTabela() {
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";
  listaDoces.sort((a, b) => a.nome.localeCompare(b.nome));
  listaDoces.forEach((doc, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${index + 1}</td><td>${doc.nome}</td>`;
    for (let i = 1; i <= totalColunas; i++) {
      const val = doc["Q" + i] || "";
      tr.innerHTML += `<td>${val}</td>`;
    }
    tbody.appendChild(tr);
  });
}

// ===== FILTROS DOS SELECTS =====
function filtrarDropdown() {
  const termo = this.value.toLowerCase();
  const select = document.getElementById("produtoSelect");
  for (let opt of select.options) {
    opt.style.display = opt.text.toLowerCase().includes(termo) ? "block" : "none";
  }
}

function filtrarDropdownRemover() {
  const termo = this.value.toLowerCase();
  const select = document.getElementById("listaRemover");
  for (let opt of select.options) {
    opt.style.display = opt.text.toLowerCase().includes(termo) ? "block" : "none";
  }
}

// ===== AÇÕES =====

function adicionarQuantidade() {
  const nome = document.getElementById("produtoSelect").value;
  const coluna = document.getElementById("colunaSelect").value;
  const input = document.getElementById("campoPeso");
  let valor = input.value.trim();

  if (!valor.match(/^\d+(\.\d{1,3})?$/)) {
    alert("Digite um número válido. Ex: 0.250");
    return;
  }

  const doce = listaDoces.find(d => d.nome === nome);

  if (doce[coluna]) {
    if (!confirm(`Já existe um valor (${doce[coluna]}) para esse doce nessa coluna. Deseja substituir?`))
      return;
  }

  doce[coluna] = valor.padEnd(5, "0");
  salvarNoLocalStorage();
  atualizarTabela();
  fecharPopup("popupAdicionarPeso");
  input.value = "";
  document.getElementById("buscaDoce").value = "";
}

function somarPeso() {
  const nome = document.getElementById("produtoSelect").value;
  const coluna = document.getElementById("colunaSelect").value;
  const campo = document.getElementById("campoPeso");
  let valorInput = campo.value.trim();

  if (!/^\d+(\.\d{1,3})?$/.test(valorInput)) {
    alert("Digite um número válido. Ex: 0.250");
    return;
  }

  const doce = listaDoces.find(d => d.nome === nome);
  if (!doce) {
    alert("Selecione um doce válido.");
    return;
  }

  let valorExistente = doce[coluna];
  if (!valorExistente || valorExistente === "") {
    alert("Esse doce não possui valor nessa coluna para somar.");
    return;
  }

  let soma = parseFloat(valorExistente) + parseFloat(valorInput);
  doce[coluna] = soma.toFixed(3);

  salvarNoLocalStorage();
  atualizarTabela();
  fecharPopup("popupAdicionarPeso");
  campo.value = "";
  document.getElementById("buscaDoce").value = "";
}

function adicionarZeros() {
  if (!confirm("Deseja adicionar 0.000 em todos os doces sem valor na coluna?")) return;
  const coluna = document.getElementById("colunaSelect").value;
  listaDoces.forEach(doc => {
    if (!doc[coluna]) doc[coluna] = "0.000";
  });
  salvarNoLocalStorage();
  atualizarTabela();
  fecharPopup("popupAdicionarPeso");
  document.getElementById("buscaDoce").value = "";
}

function limparPesosConfirm() {
  if (
    !confirm("Tem certeza que deseja limpar todos os pesos?") ||
    !confirm("Confirma novamente a limpeza de todos os pesos?") ||
    !confirm("Última confirmação, deseja realmente limpar TODOS os pesos?")
  ) return;
  listaDoces.forEach(doc => {
    for (let i = 1; i <= totalColunas; i++) {
      delete doc["Q" + i];
    }
  });
  salvarNoLocalStorage();
  atualizarTabela();
  fecharPopup("popupAdicionarPeso");
  document.getElementById("buscaDoce").value = "";
}

function adicionarColunaConfirmado() {
  const numero = parseInt(document.getElementById("numeroColuna").value);
  if (!numero || numero < 1) return alert("Número inválido.");
  totalColunas = Math.max(totalColunas, numero);
  salvarNoLocalStorage();
  atualizarDropdowns();
  atualizarTabela();
  fecharPopup("novaColunaPopup");
}

function removerColunaConfirmado() {
  const coluna = document.getElementById("colunaRemover").value;
  if (!confirm(`Tem certeza que deseja remover a coluna ${coluna}? Isso apagará todos os valores nela.`)) return;
  if (!confirm("Confirma novamente?")) return;
  if (!confirm("Última confirmação, deseja realmente apagar?")) return;
  listaDoces.forEach(doc => delete doc[coluna]);
  totalColunas--;
  salvarNoLocalStorage();
  atualizarDropdowns();
  atualizarTabela();
  fecharPopup("removerColunaPopup");
}

function adicionarLinhaConfirmado() {
  const nome = document.getElementById("nomeNovoDoce").value.trim();
  if (!nome) return;
  if (listaDoces.some(d => d.nome.toLowerCase() === nome.toLowerCase())) return alert("Doce já existe.");
  const novo = { nome };
  for (let i = 1; i <= totalColunas; i++) novo["Q" + i] = "";
  listaDoces.push(novo);
  salvarNoLocalStorage();
  atualizarDropdowns();
  atualizarTabela();
  fecharPopup("adicionarDocePopup");
}

function removerDoceConfirmado() {
  const nome = document.getElementById("listaRemover").value;
  listaDoces = listaDoces.filter(doc => doc.nome !== nome);
  salvarNoLocalStorage();
  atualizarDropdowns();
  atualizarTabela();
  fecharPopup("removerDocePopup");
}

// ===== LOCAL STORAGE =====
function salvarNoLocalStorage() {
  localStorage.setItem("listaDoces", JSON.stringify({ lista: listaDoces, colunas: totalColunas }));
}

function carregarDoLocalStorage() {
  const dados = JSON.parse(localStorage.getItem("listaDoces"));
  if (dados) {
    listaDoces = dados.lista;
    totalColunas = dados.colunas;
  }
}

// ===== EXPORTAÇÃO =====
function baixarPNG(dividido = false) {
  // Se dividir em partes de 20 doces cada
  if (dividido) {
    const grupoTamanho = 20;
    const totalGrupos = Math.ceil(listaDoces.length / grupoTamanho);
    let grupoAtual = 0;

    function baixarGrupo() {
      if (grupoAtual >= totalGrupos) return;
      const tbody = document.querySelector("#tabela tbody");
      tbody.innerHTML = "";

      const inicio = grupoAtual * grupoTamanho;
      const fim = Math.min(inicio + grupoTamanho, listaDoces.length);

      for (let i = inicio; i < fim; i++) {
        const doc = listaDoces[i];
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${doc.nome}</td>`;
        for (let c = 1; c <= totalColunas; c++) {
          tr.innerHTML += `<td>${doc["Q" + c] || ""}</td>`;
        }
        tbody.appendChild(tr);
      }

      html2canvas(document.querySelector("#tabela")).then(canvas => {
        const link = document.createElement("a");
        link.download = `lista_parte_${grupoAtual + 1}.png`;
        link.href = canvas.toDataURL();
        link.click();
        grupoAtual++;
        setTimeout(baixarGrupo, 1000);
      });
    }

    baixarGrupo();

  } else {
    html2canvas(document.querySelector("#tabela")).then(canvas => {
      const link = document.createElement("a");
      link.download = "lista.png";
      link.href = canvas.toDataURL();
      link.click();
    });
  }
}

function exportarDados() {
  const blob = new Blob([JSON.stringify({ lista: listaDoces, colunas: totalColunas }, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "lista-sabores.json";
  link.click();
}
function abrirSeletorImportacao() {
  const input = document.getElementById('importarArquivo');
  input.value = ''; // limpa o valor anterior
  input.click();    // abre o seletor de arquivos
}
function importarDados(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const dados = JSON.parse(reader.result);
      if (!dados.lista || !Array.isArray(dados.lista)) throw new Error("Formato inválido");
      listaDoces = dados.lista;
      totalColunas = dados.colunas || 1;
      salvarNoLocalStorage();
      atualizarDropdowns();
      atualizarTabela();
      alert("Importação concluída!");
    } catch (erro) {
      alert("Erro ao importar os dados. Verifique o arquivo.");
      console.error(erro);
    }
  };
  reader.readAsText(file);
}

// ===== POPUPS =====
function mostrarPopup(id) {
  document.getElementById(id).style.display = "block";
}

function fecharPopup(id) {
  document.getElementById(id).style.display = "none";
  // Limpa o campo busca doce ao fechar o popup de adicionar peso
  if (id === "popupAdicionarPeso") {
    document.getElementById("buscaDoce").value = "";
    document.getElementById("campoPeso").value = "";
  }
}
</script>
