<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Editor de Listas de Doces</title>
  <style>
    * { box-sizing: border-box; }
    html, body { width: 100%; overflow-x: hidden; margin: 0; padding: 0; }
    
    body { font-family: Arial,sans-serif; background:linear-gradient(135deg,#182848 0%,#2980b9 100%); color:#f0f0f0; margin:0; padding:0; }
    
    #btnUndo { position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:2999; background:linear-gradient(90deg,#4CAF50 0%,#45a049 100%); color:#fff; padding:10px 20px; font-size:14px; border:none; border-radius:10px; cursor:pointer; box-shadow:0 2px 12px #0005; font-weight:700; transition:background .2s,transform .1s; }
    #btnUndo:hover:not(:disabled) { background:linear-gradient(90deg,#388E3C 0%,#2E7D32 100%); transform:translateX(-50%) scale(1.04); }
    #btnUndo:disabled { background:#ccc; cursor:not-allowed; opacity:0.5; }
    
    #container { width:100%; max-width:100%; margin:80px 0 20px 0; background:rgba(30,30,30,0.92); border-radius: 12px; box-shadow:0 2px 20px #0005; padding: 14px; }
    h2 { text-align:center; color:#64b5f6; margin-top:0; margin-bottom:14px; }
    .lista-section { width:100%; background:rgba(0,0,0,0.3); border-radius:10px; padding:12px; min-height:350px; }
    .lista-section h3 { color:#64b5f6; border-bottom:2px solid #64b5f6; padding-bottom:8px; font-size:18px; margin-top:0; margin-bottom:10px; }
    table { width:100%; border-collapse:collapse; background:#1e1e1e; margin-top:8px; font-size:13px; border: 2px solid #333; }
    th,td { border:1px solid #333; padding:8px; text-align:left; color:#f0f0f0; word-wrap: break-word; overflow-wrap: break-word; min-width: 60px; width: auto;}
    th { background:#2980b9; color:#fff; font-weight:bold; font-size:13px;}
    input, select, textarea { width:100%; padding:10px; font-size:16px; margin-bottom:8px; border:2px solid #64b5f6; border-radius:4px; background:#121212; color:white; box-sizing:border-box; }
    input:focus, select:focus, textarea:focus { border-color:#2980b9; outline:none;}
    button { background: linear-gradient(90deg,#2196f3 0%,#64b5f6 100%); color:#fff; padding:11px 16px; font-size:14px; border:none; border-radius:6px; cursor:pointer; margin-bottom:8px; font-weight:600; transition:background .2s,transform .1s; }
    button:hover { background:linear-gradient(90deg,#1976d2 0%,#2980b9 100%);}
    .btn-group { text-align:center; margin-bottom:12px; display:flex; gap:6px; flex-wrap:wrap; justify-content:center; width:100%; }
    .btn-group button { margin:0; flex:1; min-width:90px; padding:11px 12px; font-size:13px; }
    .btn-group select { padding:10px 10px; font-size:14px; margin:0; flex:1; min-width:90px; }
    
    .popup {
      position:fixed;
      left:auto;
      right:20px;
      top:80px;
      width:90vw;
      max-width:500px;
      background:#232a34;
      padding:20px;
      border-radius: 12px;
      box-shadow:0 2px 30px #0008;
      z-index:3001;
      display:none;
      max-height:calc(100vh - 150px);
      overflow-y:auto;
      box-sizing: border-box;
    }
    
    .popup h3 { color:#64b5f6; margin-top:0; margin-bottom:16px; font-size:18px; }
    .popup label { color: #fff; font-weight: 600; display: block; margin-bottom: 6px; font-size:13px;}
    .popup input, .popup select { margin-bottom:14px; font-size:16px; padding:12px;}
    .popup button { margin-right:0; margin-bottom:8px; width:100%; font-size:15px; padding:14px;}
    
    #overlay { position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;display:none;z-index:3000; }
    #aviso {width:100%; margin:16px 0 0 0; padding:12px 16px; background:rgba(30,30,30,0.96); border-radius:10px; text-align:center; font-size:13px; box-shadow:0 2px 10px #0003;}
    .red-btn { background: linear-gradient(135deg,#d32f2f 0%,#b71c1c 100%) !important; color: #fff !important; border: none; }
    .red-btn:hover { background: linear-gradient(135deg,#c62828 0%,#b71c1c 100%) !important;}
    .green-btn { background: linear-gradient(135deg,#4CAF50 0%,#45a049 100%) !important; color: #fff !important; border: none; }
    .green-btn:hover { background: linear-gradient(135deg,#388E3C 0%,#2E7D32 100%) !important;}
    .blue-btn { background: linear-gradient(90deg,#2196f3 0%,#64b5f6 100%) !important; color: #fff !important; border: none; }
    .blue-btn:hover { background: linear-gradient(90deg,#1976d2 0%,#2980b9 100%) !important;}
    .purple-btn { background: linear-gradient(135deg,#9b27b0 0%,#af40bf 100%) !important; color: #fff !important; border: none; }
    .purple-btn:hover { background: linear-gradient(135deg,#7a1884 0%,#922a9e 100%) !important;}
    .trash-btn {
      background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%) !important;
      color: #fff !important;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 14px;
      padding: 0;
      cursor:pointer;
      line-height: 32px;
      text-align:center;
      vertical-align: middle;
    }
    .trash-btn:hover {
      background: linear-gradient(135deg, #b71c1c 0%, #7d0909 100%) !important;
    }
    .inline { display:inline-block; margin-right:6px; margin-bottom:0; }

    @media (max-width:768px){
      .popup { width: 95vw; max-width: 95vw; right: 10px; }
      .btn-group { gap: 5px; }
      .btn-group button, .btn-group select { min-width: 85px; padding: 10px 10px; font-size: 12px; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div id="aviso">
    <b>üìã Editor de Listas de Doces</b> Organize suas listas com emojis e facilidade!
  </div>
  
  <div id="container">
    <div style="margin-bottom:10px;">
      <button id="btnUndo" disabled>‚Ü∂ Desfazer (Ctrl+Z)</button>
    </div>

    <div class="btn-group">
      <select id="listaSelect" style="flex: 2;"></select>
      <button id="btnNovaLista" class="green-btn">‚ûï Nova</button>
      <button id="btnRemoverLista" class="red-btn">‚úï Remover</button>
    </div>

    <div class="btn-group">
      <button id="btnAddDoce" class="blue-btn">üç¨ Adicionar</button>
      <button id="btnRemDoce" class="blue-btn">üóëÔ∏è Remover</button>
      <button id="btnAddPeso">‚öñÔ∏è Peso</button>
      <button id="btnColunas">üìä Colunas</button>
    </div>

    <div class="btn-group">
      <button id="btnExportar">üì• Exportar</button>
      <button id="btnImportar">üì§ Importar</button>
      <input id="importar" type="file" accept=".json" style="display:none">
      <button id="btnPNG">üñºÔ∏è PNG</button>
      <button id="btnPDF">üìÑ PDF</button>
      <button id="btnApagarTudo" class="red-btn">üóëÔ∏è Apagar</button>
    </div>

    <div class="btn-group">
      <select id="ordenacaoSelect" style="flex: 2;">
        <option value="alfabetica">üìù Alfab√©tica</option>
        <option value="pesoAsc">‚¨ÜÔ∏è Peso crescente</option>
        <option value="pesoDesc">‚¨áÔ∏è Peso decrescente</option>
      </select>
    </div>

    <div class="lista-section" id="listaSection">
      <h3 id="tituloLista">üç¨ Lista de Doces</h3>
      <table id="tabela">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <div id="overlay"></div>

  <!-- POPUP NOVA LISTA -->
  <div class="popup" id="popup-novaLista">
    <h3>üìã Nova Lista</h3>
    <label>Nome da lista:</label>
    <input type="text" id="nomeLista" placeholder="Ex: Doces Festa">
    
    <label>Tipo de lista:</label>
    <select id="tipoLista">
      <option value="peso">‚öñÔ∏è Peso (0,000 a 99,999)</option>
      <option value="unidade">üî¢ Unidade (0 a 99999)</option>
    </select>
    
    <button id="popupNovaListaBtn" class="green-btn">Criar</button>
    <button class="popupCancelBtn">Cancelar</button>
  </div>

  <!-- POPUP ADICIONAR DOCE -->
  <div class="popup" id="popup-addDoce">
    <h3>üç¨ Novo Doce</h3>
    <label>Nome do doce:</label>
    <input type="text" id="novoDoce" placeholder="Ex: Chocolate üç´">
    
    <button id="popupAddDoceBtn" class="blue-btn">Adicionar</button>
    <button class="popupCancelBtn">Cancelar</button>
  </div>

  <!-- POPUP REMOVER DOCE -->
  <div class="popup" id="popup-remDoce">
    <h3>üóëÔ∏è Remover Doce</h3>
    <label>Buscar doce:</label>
    <input type="text" id="buscaRemover" placeholder="Digite para buscar...">
    
    <label>Selecione:</label>
    <select id="selRemover"></select>
    
    <button id="popupRemDoceBtn" class="red-btn">Remover</button>
    <button class="popupCancelBtn">Cancelar</button>
  </div>

  <!-- POPUP ADICIONAR PESO -->
  <div class="popup" id="popup-addPeso">
    <h3>‚öñÔ∏è Gerenciar Pesos</h3>
    <label>Buscar doce:</label>
    <input type="text" id="buscaPeso" placeholder="Digite para buscar...">
    
    <label>Doce:</label>
    <select id="selPesoDoce"></select>
    
    <label>Coluna:</label>
    <select id="selPesoCol"></select>
    
    <label>Valor:</label>
    <input type="text" id="pesoNovo" maxlength="7" placeholder="0.000 ou 0">
    
    <div style="margin-bottom:10px; display:flex; gap:6px; flex-wrap:wrap;">
      <button id="btnAddPesoPopup" class="green-btn inline" style="flex:1; margin:0;">‚ûï Adicionar</button>
      <button id="btnSomarPeso" class="green-btn inline" style="flex:1; margin:0;">‚ûï Somar</button>
      <button id="btnLimparPeso" class="red-btn inline" style="flex:1; margin:0;">‚úï Limpar</button>
      <button id="btnDesbloqueia" class="red-btn inline" style="display:none; flex:1; margin:0;">üîì Desbloquear</button>
    </div>
    
    <button id="btnLimparTodosPesos" class="red-btn" style="width:100%; margin-bottom:10px;">üóëÔ∏è Limpar Tudo da Coluna</button>
    <button id="btnCalcularTotal" class="purple-btn" style="width:100%; margin-bottom:10px;">üìä Calcular Total</button>
    <button id="btnPreencherZeros" class="blue-btn" style="width:100%; margin-bottom:10px;">0Ô∏è‚É£ Preencher Vazios</button>
    
    <button class="popupCancelBtn">Cancelar</button>
  </div>

  <!-- POPUP COLUNAS -->
  <div class="popup" id="popup-colunas">
    <h3>üìä Gerenciar Colunas</h3>
    <button id="btnNovaColuna" class="green-btn" style="width:100%; margin-bottom:10px;">‚ûï Nova Coluna</button>
    
    <label>Remover coluna:</label>
    <select id="selRemCol"></select>
    
    <button id="btnRemColuna" class="red-btn" style="width:100%; margin-bottom:10px;">‚úï Remover Coluna</button>
    <button class="popupCancelBtn">Fechar</button>
  </div>

  <!-- POPUP EXPORTAR PNG -->
  <div class="popup" id="popup-exportarPNG">
    <h3>üñºÔ∏è Exportar PNG</h3>
    <p style="color:#aaa; text-align:center; margin-bottom:16px;">Escolha como exportar sua lista:</p>
    
    <button id="btnExportarChunk" class="green-btn" style="width:100%; margin-bottom:10px;">üì¶ V√°rias Partes</button>
    <button id="btnExportarUnico" class="purple-btn" style="width:100%; margin-bottom:10px;">üé® Uma Imagem √önica</button>
    
    <button class="popupCancelBtn">Cancelar</button>
  </div>

  <!-- POPUP EXPORTAR PDF -->
  <div class="popup" id="popup-exportarPDF">
    <h3>üìÑ Exportar PDF</h3>
    <p style="color:#aaa; text-align:center; margin-bottom:16px;">Escolha o tipo de PDF:</p>
    
    <button id="btnExportarPDFPreenchido" class="green-btn" style="width:100%; margin-bottom:10px;">‚úÖ Com Dados</button>
    
    <button class="popupCancelBtn">Cancelar</button>
  </div>

  <!-- POPUP INFORMA√á√ÉO PDF -->
  <div class="popup" id="popup-infoPDF">
    <h3>üìÑ Como Usar o PDF</h3>
    <p style="color:#fff; margin-bottom:12px; font-size:14px;">
      <b>1Ô∏è‚É£ Baixar:</b> Clique no bot√£o "Salvar" que aparecer√° no seu navegador
    </p>
    <p style="color:#fff; margin-bottom:12px; font-size:14px;">
      <b>2Ô∏è‚É£ Salvar em Pendrive:</b> Conecte o pendrive, copie o arquivo PDF para ele
    </p>
    <p style="color:#fff; margin-bottom:12px; font-size:14px;">
      <b>3Ô∏è‚É£ Imprimir:</b> Abra o PDF em qualquer computador, clique em Print (Ctrl+P), escolha sua impressora e imprima!
    </p>
    <p style="color:#64b5f6; margin-bottom:16px; font-size:14px; text-align:center;">
      ‚úÖ Pronto para usar! A lista saiu perfeita no papel!
    </p>
    <button class="popupCancelBtn" style="width:100%;">Entendi!</button>
  </div>

  <!-- POPUP CONFIRMAR SUBSTITUI√á√ÉO -->
  <div class="popup" id="popup-confirmarSubstituicao">
    <h3>‚ö†Ô∏è Valor Atual</h3>
    <p id="valorAtualText" style="font-size: 16px; margin-bottom: 16px; color: #64b5f6; text-align: center;"></p>
    <p style="margin-bottom: 16px; color: #fff;">Este doce j√° possui um valor nesta coluna.</p>
    <button class="popupCancelBtn" style="width: 100%;">OK</button>
  </div>

  <script>
    let todasListas={}, listaAtual="", listaDoces=[], totalColunas=1, tipoLista="peso";
    let historicoAcoes = [];
    let ordenacaoAtual = "alfabetica";
    let pesoBloqueado = false;

    document.addEventListener("DOMContentLoaded",()=>{
      carregarTodasListas();
      desenharTabela();

      document.querySelectorAll('.popupCancelBtn').forEach(btn=>{
        btn.onclick = fecharPopup;
      });

      document.getElementById("btnUndo").onclick = desfazer;
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "z") {
          e.preventDefault();
          desfazer();
        }
      });

      document.getElementById("btnNovaLista").onclick = () => abrirPopup('novaLista');
      document.getElementById("popupNovaListaBtn").onclick = novaLista;
      document.getElementById("btnRemoverLista").onclick = removerLista;
      document.getElementById("listaSelect").onchange = trocarLista;
      document.getElementById("btnAddDoce").onclick = ()=>abrirPopup('addDoce');
      document.getElementById("btnRemDoce").onclick = ()=>abrirPopup('remDoce');
      document.getElementById("btnAddPeso").onclick = ()=>abrirPopup('addPeso');
      document.getElementById("btnColunas").onclick = ()=>abrirPopup('colunas');
      document.getElementById("btnExportar").onclick = confirmarExportar;
      document.getElementById("btnImportar").onclick = confirmarImportar;
      document.getElementById("importar").onchange = importar;
      document.getElementById("btnPNG").onclick = ()=>abrirPopup('exportarPNG');
      document.getElementById("btnPDF").onclick = ()=>abrirPopup('exportarPDF');
      document.getElementById("btnApagarTudo").onclick = apagarTudo;
      document.getElementById("ordenacaoSelect").onchange = ordenarLista;

      document.getElementById("popupAddDoceBtn").onclick = addDoce;
      document.getElementById("popupRemDoceBtn").onclick = remDoce;

      document.getElementById("btnAddPesoPopup").onclick = addPeso;
      document.getElementById("btnDesbloqueia").onclick = desbloquearPeso;
      document.getElementById("btnSomarPeso").onclick = somarPeso;
      document.getElementById("btnLimparPeso").onclick = limparPeso;
      document.getElementById("btnLimparTodosPesos").onclick = limparTodosPesosColuna;
      document.getElementById("buscaPeso").addEventListener('input', filtrarDropdownPeso);
      document.getElementById("btnCalcularTotal").onclick = calcularPesoTotal;
      document.getElementById("btnPreencherZeros").onclick = preencherZeros;

      document.getElementById("buscaRemover").addEventListener('input', filtrarDropdownRemover);

      document.getElementById("btnExportarChunk").onclick = function(){
        fecharPopup(); baixarPNGVarios();
      };
      document.getElementById("btnExportarUnico").onclick = function(){
        fecharPopup(); baixarPNGUnico();
      };
      document.getElementById("btnExportarPDFPreenchido").onclick = function(){
        fecharPopup(); exportarPDFPreenchido();
      };

      let pesoInput = document.getElementById('pesoNovo');
      pesoInput.addEventListener('input', function(e){
        let v = this.value;
        if (tipoLista === "peso" && v.length === 1 && /\d/.test(v) && !v.includes('.')) {
          this.value = v + '.';
          this.setSelectionRange(this.value.length, this.value.length);
        }
      });

      document.getElementById("btnNovaColuna").onclick = novaColuna;
      document.getElementById("btnRemColuna").onclick = remColuna;
      document.getElementById('overlay').onclick = fecharPopup;
    });

    // UNDO SYSTEM
    function salvarAcao(descricao) {
      historicoAcoes.push({
        descricao: descricao,
        estado: {
          todasListas: JSON.parse(JSON.stringify(todasListas)),
          listaAtual: listaAtual,
          listaDoces: JSON.parse(JSON.stringify(listaDoces)),
          totalColunas: totalColunas,
          tipoLista: tipoLista
        }
      });
      atualizarBtnUndo();
    }

    function desfazer() {
      if (historicoAcoes.length === 0) {
        alert("Nenhuma a√ß√£o para desfazer!");
        return;
      }

      const ultimaAcao = historicoAcoes.pop();
      const estadoAnterior = ultimaAcao.estado;

      todasListas = estadoAnterior.todasListas;
      listaAtual = estadoAnterior.listaAtual;
      listaDoces = estadoAnterior.listaDoces;
      totalColunas = estadoAnterior.totalColunas;
      tipoLista = estadoAnterior.tipoLista;

      atualizarListaSelect();
      desenharTabela();
      salvarTodasListas();
      atualizarBtnUndo();
    }

    function atualizarBtnUndo() {
      document.getElementById("btnUndo").disabled = historicoAcoes.length === 0;
    }

    // LISTAS
    function novaLista() {
      let nome = document.getElementById('nomeLista').value.trim();
      let tipo = document.getElementById('tipoLista').value;
      let nomeComEmoji = (tipo === "peso" ? "‚öñÔ∏è" : "üî¢") + " " + nome;
      
      if(!nome || todasListas[nomeComEmoji]) return alert("Nome j√° existe ou inv√°lido!");
      
      salvarAcao(`Criar lista "${nomeComEmoji}"`);
      
      todasListas[nomeComEmoji]={listaDoces:[],totalColunas:1,tipo:tipo}; 
      listaAtual=nomeComEmoji;
      carregarListaAtual(); 
      atualizarListaSelect(); 
      salvarTodasListas();
      fecharPopup();
      document.getElementById('nomeLista').value = "";
    }

    function removerLista() {
      if(!listaAtual || listaAtual === "") return alert("Nenhuma lista selecionada!");
      if(listaAtual === "‚öñÔ∏è Peso" || listaAtual === "üî¢ Unidade") return alert("N√£o pode remover as listas principais!");
      if(!confirm("Tem certeza?")) return;
      
      salvarAcao(`Remover lista "${listaAtual}"`);
      
      delete todasListas[listaAtual];
      let chaves = Object.keys(todasListas);
      listaAtual = chaves.length > 0 ? chaves[0] : "";
      
      if(listaAtual) {
        carregarListaAtual();
      } else {
        listaDoces = [];
        desenharTabela();
      }
      atualizarListaSelect(); 
      salvarTodasListas();
    }

    function trocarLista() {
      listaAtual = document.getElementById("listaSelect").value;
      if(listaAtual) {
        carregarListaAtual();
        desenharTabela();
      }
    }

    function atualizarListaSelect() {
      let sel = document.getElementById("listaSelect"); 
      sel.innerHTML="";
      Object.keys(todasListas).forEach(nome=>{
        let opt=document.createElement("option");
        opt.value=opt.text=nome; 
        sel.appendChild(opt);
      }); 
      sel.value=listaAtual;
    }

    // LOCALSTORAGE
    function salvarTodasListas() {
      if(listaAtual) {
        todasListas[listaAtual]={listaDoces,totalColunas,tipo:tipoLista};
      }
      localStorage.setItem("todasListas",JSON.stringify(todasListas));
    }

    function carregarTodasListas() {
      try {
        todasListas=JSON.parse(localStorage.getItem("todasListas"))||{};
        
        // REMOVE LISTAS ANTIGAS (compatibilidade)
        delete todasListas["üç¨ Lista Principal (Peso)"];
        delete todasListas["üç¨ Lista Principal (Unidade)"];
        delete todasListas["Lista principal (LPP)"];
        delete todasListas["Lista principal (LPU)"];
        
        // CRIA LISTAS PRINCIPAIS SE N√ÉO EXISTIREM
        if (!todasListas["‚öñÔ∏è Peso"]) {
          todasListas["‚öñÔ∏è Peso"] = {listaDoces:[],totalColunas:1,tipo:"peso"};
        }
        if (!todasListas["üî¢ Unidade"]) {
          todasListas["üî¢ Unidade"] = {listaDoces:[],totalColunas:1,tipo:"unidade"};
        }
        
        let chaves = Object.keys(todasListas);
        if(chaves.length === 0) {
          listaAtual = "‚öñÔ∏è Peso";
          listaDoces = [];
          totalColunas = 1;
          tipoLista = "peso";
        } else {
          listaAtual = chaves[0];
          carregarListaAtual();
        }
      }catch{ 
        listaAtual = "‚öñÔ∏è Peso";
        todasListas = {
          "‚öñÔ∏è Peso": {listaDoces:[],totalColunas:1,tipo:"peso"},
          "üî¢ Unidade": {listaDoces:[],totalColunas:1,tipo:"unidade"}
        };
        listaDoces = [];
        carregarListaAtual();
      }
      atualizarListaSelect();
    }

    function carregarListaAtual() {
      if(!listaAtual || !todasListas[listaAtual]) return;
      let dados = todasListas[listaAtual];
      listaDoces = dados.listaDoces || []; 
      totalColunas = dados.totalColunas || 1;
      tipoLista = dados.tipo || "peso";
      desenharTabela(); 
      salvarTodasListas();
    }

    // TABELA COM LINHAS
    function desenharTabela(subset=null) {
      let docesParaDesenhar = subset || listaDoces;
      let ths = `<tr><th>#</th><th>üç¨ Doce</th>`;
      for(let i=1;i<=totalColunas;i++) ths+=`<th>Q${i}</th>`;
      ths+=`</tr>`;
      document.querySelector("#tabela thead").innerHTML = ths;
      let tds = '';
      docesParaDesenhar.forEach((doc,i)=>{
        tds+=`<tr><td>${i+1}</td><td>${doc.nome}</td>`;
        for(let c=1;c<=totalColunas;c++) tds+=`<td>${doc["Q"+c]||""}</td>`;
        tds+=`</tr>`;
      });
      document.querySelector("#tabela tbody").innerHTML = tds;
    }

    function abrirPopup(tipo) {
      document.getElementById('overlay').style.display='block';
      document.querySelectorAll('.popup').forEach(p=>p.style.display='none');
      let popup = document.getElementById('popup-'+tipo);
      if (popup) popup.style.display='block';

      if(tipo==='remDoce') {
        montarSelRemover();
        document.getElementById('buscaRemover').value = "";
        filtrarDropdownRemover();
      }
      if(tipo==='addPeso') {
        pesoBloqueado = false;
        document.getElementById('btnAddPesoPopup').disabled = false;
        document.getElementById('btnSomarPeso').disabled = false;
        document.getElementById('btnLimparPeso').disabled = false;
        document.getElementById('btnDesbloqueia').style.display = 'none';
        
        montarSelPeso();
        document.getElementById('buscaPeso').value = "";
        document.getElementById('pesoNovo').value = "";
        let sel = document.getElementById('selPesoDoce');
        let erradoOpt = document.createElement('option');
        erradoOpt.value = erradoOpt.text = 'errado';
        sel.insertBefore(erradoOpt, sel.firstChild);
        sel.value = 'errado';
        filtrarDropdownPeso();

        if (tipoLista === "unidade") {
          document.getElementById('btnCalcularTotal').style.display = 'none';
          document.getElementById('btnPreencherZeros').innerHTML = '0Ô∏è‚É£ Preencher com 0';
        } else {
          document.getElementById('btnCalcularTotal').style.display = 'block';
          document.getElementById('btnPreencherZeros').innerHTML = '0Ô∏è‚É£ Preencher com 0,000';
        }
      }
      if(tipo==='colunas') montarSelColuna();
    }

    function fecharPopup() {
      document.getElementById('overlay').style.display='none';
      document.querySelectorAll('.popup').forEach(p=>p.style.display='none');
    }

    // DOCES
    function addDoce() {
      let nome = document.getElementById('novoDoce').value.trim();
      if(!nome) return alert("Nome vazio!");
      if(listaDoces.some(d=>d.nome.toLowerCase()===nome.toLowerCase())) return alert("Doce j√° existe!");
      
      salvarAcao(`Adicionar doce "${nome}"`);
      
      let novo = {nome};
      for(let i=1;i<=totalColunas;i++) novo["Q"+i]="";
      listaDoces.push(novo);
      aplicarOrdenacao();
      desenharTabela();
      fecharPopup();
      salvarTodasListas();
      document.getElementById('novoDoce').value="";
    }

    function montarSelRemover() {
      let sel = document.getElementById('selRemover');
      sel.innerHTML='';
      listaDoces.forEach(d=>{
        let opt=document.createElement('option');
        opt.value=opt.text=d.nome;
        sel.appendChild(opt);
      });
    }

    function filtrarDropdownRemover() {
      let termo = document.getElementById('buscaRemover').value.trim().toLowerCase();
      let sel = document.getElementById('selRemover');
      for(let i=0;i<sel.options.length;i++) {
        let opt = sel.options[i];
        let optTxt = opt.text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        let termoBusca = termo.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, " ").trim();
        let optBusca = optTxt.replace(/\s+/g, " ").trim();
        opt.style.display = optBusca.includes(termoBusca) ? "block" : "none";
      }
      let visiveis = [...sel.options].filter(o => o.style.display == "block");
      if (!visiveis.some(o => o.value === sel.value)) {
        if (visiveis.length) {
          sel.value = visiveis[0].value;
        }
      }
    }

    function remDoce() {
      let nome = document.getElementById('selRemover').value;
      
      salvarAcao(`Remover doce "${nome}"`);
      
      listaDoces = listaDoces.filter(d=>d.nome!==nome);
      desenharTabela(); 
      fecharPopup(); 
      salvarTodasListas();
    }

    // PESOS
    function filtrarDropdownPeso() {
      let termo = document.getElementById('buscaPeso').value.trim().toLowerCase();
      let sel = document.getElementById('selPesoDoce');
      for(let i=0;i<sel.options.length;i++) {
        let opt = sel.options[i];
        if (opt.value === 'errado') {
          opt.style.display = "none";
          continue;
        }
        let optTxt = opt.text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        let termoBusca = termo.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, " ").trim();
        let optBusca = optTxt.replace(/\s+/g, " ").trim();
        opt.style.display = optBusca.includes(termoBusca) ? "block" : "none";
      }
      let visiveis = [...sel.options].filter(o => o.style.display == "block" && o.value !== 'errado');
      if (!visiveis.some(o => o.value === sel.value)) {
        sel.value = 'errado';
      }
    }

    function montarSelPeso() {
      let selD = document.getElementById('selPesoDoce');
      let selC = document.getElementById('selPesoCol');
      
      let selectedValue = selD.value;
      selD.innerHTML = '';
      
      listaDoces.forEach(d=>{
        let opt=document.createElement('option');
        opt.value=opt.text=d.nome;
        selD.appendChild(opt);
      });
      
      selC.innerHTML = '';
      for(let i=1;i<=totalColunas;i++){
        let opt=document.createElement('option');
        opt.value=opt.text="Q"+i;
        selC.appendChild(opt);
      }
    }

    function validarPeso(valor) {
      if (tipoLista === "unidade") {
        return /^\d+$/.test(valor) && parseInt(valor) >= 0 && parseInt(valor) <= 99999;
      } else {
        return /^\d+(\.\d{1,3})?$/.test(valor);
      }
    }

    function formatarPeso(valor) {
      if (tipoLista === "unidade") {
        return valor.padEnd(5, "0");
      } else {
        return valor.padEnd(5, "0");
      }
    }

    function addPeso() {
      if(pesoBloqueado) return;
      
      let doce = document.getElementById('selPesoDoce').value;
      let coluna = document.getElementById('selPesoCol').value;
      let valor = document.getElementById('pesoNovo').value.trim();
      
      if(doce==='errado') {
        pesoBloqueado = true;
        document.getElementById('btnAddPesoPopup').disabled = true;
        document.getElementById('btnSomarPeso').disabled = true;
        document.getElementById('btnLimparPeso').disabled = true;
        document.getElementById('btnDesbloqueia').style.display = 'inline-block';
        alert("Voc√™ tentou adicionar peso ao item 'errado'. O bot√£o est√° bloqueado. Clique no üîì Desbloquear para desbloquear.");
        return;
      }
      
      if(!validarPeso(valor)) return alert(`Valor inv√°lido! ${tipoLista === "unidade" ? "Use n√∫meros inteiros entre 0 e 99999." : "Use formato 0.000"}`);
      
      let doceObj = listaDoces.find(d=>d.nome===doce);
      if(doceObj[coluna]) {
        document.getElementById('valorAtualText').textContent = `Valor atual: ${doceObj[coluna]}`;
        abrirPopup('confirmarSubstituicao');
        return;
      }
      
      salvarAcao(`Adicionar peso ao doce "${doce}"`);
      
      doceObj[coluna]=formatarPeso(valor);
      desenharTabela();
      salvarTodasListas();
      document.getElementById('pesoNovo').value="";
      document.getElementById('selPesoDoce').value = 'errado';
    }

    function desbloquearPeso() {
      pesoBloqueado = false;
      document.getElementById('btnAddPesoPopup').disabled = false;
      document.getElementById('btnSomarPeso').disabled = false;
      document.getElementById('btnLimparPeso').disabled = false;
      document.getElementById('btnDesbloqueia').style.display = 'none';
    }

    function somarPeso() {
      if(pesoBloqueado) return;
      
      let doce = document.getElementById('selPesoDoce').value;
      let coluna = document.getElementById('selPesoCol').value;
      let valor = document.getElementById('pesoNovo').value.trim();
      
      if(doce==='errado') {
        pesoBloqueado = true;
        document.getElementById('btnAddPesoPopup').disabled = true;
        document.getElementById('btnSomarPeso').disabled = true;
        document.getElementById('btnLimparPeso').disabled = true;
        document.getElementById('btnDesbloqueia').style.display = 'inline-block';
        alert("Voc√™ tentou somar peso ao item 'errado'. O bot√£o est√° bloqueado. Clique no üîì Desbloquear para desbloquear.");
        return;
      }
      
      let doceObj = listaDoces.find(d=>d.nome===doce);
      if(!doceObj[coluna]) return alert("Esse doce n√£o possui peso definido nessa coluna para somar.");
      if(!validarPeso(valor)) return alert(`Valor inv√°lido! ${tipoLista === "unidade" ? "Use n√∫meros inteiros entre 0 e 99999." : "Use formato 0.000"}`);
      
      let atual = parseFloat(doceObj[coluna]);
      let novo = parseFloat(valor);
      let soma = atual + novo;
      
      if (tipoLista === "unidade" && soma > 99999) return alert("Soma ultrapassa o limite de 99999!");
      
      if(!confirm(`Peso atual: ${doceObj[coluna]}\nDeseja somar ${valor}?\nResultado: ${tipoLista === "unidade" ? Math.floor(soma) : soma.toFixed(3)}`)) return;
      
      salvarAcao(`Somar peso ao doce "${doce}"`);
      
      if (tipoLista === "unidade") {
        doceObj[coluna] = Math.floor(soma).toString().padEnd(5, "0");
      } else {
        doceObj[coluna] = soma.toFixed(3);
      }
      desenharTabela();
      salvarTodasListas();
      document.getElementById('pesoNovo').value="";
      document.getElementById('selPesoDoce').value = 'errado';
    }

    function limparPeso() {
      if(pesoBloqueado) return;
      
      let doce = document.getElementById('selPesoDoce').value;
      let coluna = document.getElementById('selPesoCol').value;
      
      if(doce==='errado') {
        pesoBloqueado = true;
        document.getElementById('btnAddPesoPopup').disabled = true;
        document.getElementById('btnSomarPeso').disabled = true;
        document.getElementById('btnLimparPeso').disabled = true;
        document.getElementById('btnDesbloqueia').style.display = 'inline-block';
        alert("Voc√™ tentou limpar peso do item 'errado'. O bot√£o est√° bloqueado. Clique no üîì Desbloquear para desbloquear.");
        return;
      }
      
      let doceObj = listaDoces.find(d=>d.nome===doce);
      if(!doceObj[coluna]) return alert("Esse doce j√° est√° sem peso nessa coluna.");
      if(!confirm("Deseja realmente limpar o peso desse doce na coluna selecionada?")) return;
      
      salvarAcao(`Limpar peso do doce "${doce}"`);
      
      doceObj[coluna] = "";
      desenharTabela();
      salvarTodasListas();
      document.getElementById('pesoNovo').value="";
      document.getElementById('selPesoDoce').value = 'errado';
    }

    function limparTodosPesosColuna() {
      let coluna = document.getElementById('selPesoCol').value;
      if(!coluna) return alert("Selecione a coluna!");
      if(!confirm("Isso vai remover TODOS os pesos dos doces da coluna " + coluna + ". Tem certeza?")) return;
      
      salvarAcao(`Limpar todos os pesos da coluna ${coluna}`);
      
      listaDoces.forEach(doc=>doc[coluna]="");
      desenharTabela();
      salvarTodasListas();
      alert("‚úÖ Todos os pesos da coluna " + coluna + " foram limpos.");
    }

    function calcularPesoTotal() {
      let total = 0;
      listaDoces.forEach(doc => {
        for(let i=1; i<=totalColunas; i++) {
          let val = parseFloat(doc["Q"+i]);
          if(!isNaN(val)) total += val;
        }
      });
      alert(`üìä Peso total de todos os doces na lista: ${total.toFixed(3)}`);
    }

    function preencherZeros() {
      let coluna = document.getElementById('selPesoCol').value;
      if(!coluna) return alert("Selecione a coluna!");
      
      let preenchimento = tipoLista === "unidade" ? "0" : "0.000";
      if(!confirm(`Isso ir√° preencher com ${preenchimento} todos os doces SEM valor na coluna selecionada. Deseja continuar?`)) return;
      if(!confirm("Essa a√ß√£o √© irrevers√≠vel para esses doces. Tem certeza MESMO?")) return;
      
      salvarAcao(`Preencher vazios da coluna ${coluna}`);
      
      let alterou = false;
      listaDoces.forEach(doc=>{
        if(!doc[coluna]) { doc[coluna]=preenchimento; alterou=true; }
      });
      if(alterou) {
        desenharTabela();
        salvarTodasListas();
        alert(`‚úÖ Todos os doces sem valor nessa coluna receberam ${preenchimento}.`);
      } else {
        alert("N√£o havia nenhum doce sem valor nessa coluna.");
      }
    }

    // COLUNAS
    function montarSelColuna() {
      let sel = document.getElementById('selRemCol');
      sel.innerHTML = '';
      for(let i=1;i<=totalColunas;i++){
        let opt=document.createElement('option');
        opt.value=opt.text="Q"+i;
        sel.appendChild(opt);
      }
    }

    function novaColuna() {
      if (totalColunas >= 10) return alert("Limite de 10 colunas atingido!");
      
      salvarAcao("Adicionar coluna");
      
      totalColunas++;
      listaDoces.forEach(d=>d["Q"+totalColunas]="");
      desenharTabela(); 
      montarSelColuna(); 
      salvarTodasListas();
      alert("‚úÖ Nova coluna adicionada!");
    }

    function remColuna() {
      if (totalColunas === 1) return alert("Deve haver pelo menos uma coluna!");
      
      let col = document.getElementById('selRemCol').value;
      if(!confirm(`Deseja remover a coluna ${col} e todos os seus dados?`)) return;
      
      salvarAcao(`Remover coluna ${col}`);
      
      listaDoces.forEach(d=>delete d[col]);
      totalColunas--;
      desenharTabela(); 
      montarSelColuna(); 
      salvarTodasListas();
      alert("‚úÖ Coluna removida!");
    }

    // EXPORTAR/IMPORTAR
    function confirmarExportar() {
      if(!listaAtual) return alert("Nenhuma lista para exportar!");
      if(!confirm("Deseja exportar os dados da lista atual?")) return;
      salvar();
    }

    function salvar() {
      let blob=new Blob([JSON.stringify({listaDoces,totalColunas,tipo:tipoLista},null,2)],{type:"application/json"});
      let link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download="lista-doces.json";
      link.click();
    }

    function confirmarImportar() {
      if(!confirm("Deseja importar uma lista (isso ir√° substituir a atual)?")) return;
      document.getElementById('importar').click();
    }

    function importar(e) {
      let file = e.target.files[0];
      if(!file) return;
      let reader=new FileReader();
      reader.onload=()=>{
        try {
          let dados=JSON.parse(reader.result);
          if(!dados.listaDoces||!Array.isArray(dados.listaDoces)) throw "Formato inv√°lido";
          
          salvarAcao("Importar lista");
          
          listaDoces=dados.listaDoces;
          totalColunas=dados.totalColunas||1;
          tipoLista=dados.tipo||"peso";
          desenharTabela(); 
          salvarTodasListas();
          alert("‚úÖ Importado com sucesso!");
        } catch {
          alert("‚ùå Erro ao importar. Arquivo inv√°lido.");
        }
      };
      reader.readAsText(file);
    }

    // APAGAR TUDO
    function apagarTudo() {
      if(!confirm("Isso apagar√° toda a lista!")) return;
      if(!confirm("Essa a√ß√£o N√ÉO pode ser desfeita com o undo. Tem certeza MESMO?")) return;
      
      listaDoces=[]; 
      totalColunas=1;
      desenharTabela(); 
      salvarTodasListas();
      alert("üóëÔ∏è Lista apagada!");
    }

    // ORDENA√á√ÉO
    function aplicarOrdenacao() {
      ordenarListaPor(ordenacaoAtual);
    }

    function ordenarLista() {
      ordenacaoAtual = document.getElementById("ordenacaoSelect").value;
      ordenarListaPor(ordenacaoAtual);
      desenharTabela();
    }

    function ordenarListaPor(modo) {
      const coluna = "Q1";
      if (modo === "alfabetica") {
        listaDoces.sort((a,b)=>a.nome.localeCompare(b.nome));
      } else if (modo === "pesoAsc") {
        listaDoces.sort((a,b)=>{
          let pa = parseFloat(a[coluna]);
          let pb = parseFloat(b[coluna]);
          if(isNaN(pa))pa=Infinity;if(isNaN(pb))pb=Infinity;
          if(pa===pb)return a.nome.localeCompare(b.nome);
          return pa-pb;
        });
      } else if (modo === "pesoDesc") {
        listaDoces.sort((a,b)=>{
          let pa = parseFloat(a[coluna]);
          let pb = parseFloat(b[coluna]);
          if(isNaN(pa))pa=-Infinity;if(isNaN(pb))pb=-Infinity;
          if(pa===pb)return a.nome.localeCompare(b.nome);
          return pb-pa;
        });
      }
    }

    // PNG
    function baixarPNGVarios() {
      if (!listaDoces.length) {
        alert("A lista est√° vazia!");
        return;
      }
      const total = listaDoces.length;
      const chunkSize = 20;
      let origTHead = document.querySelector("#tabela thead").innerHTML;

      let baixarChunk = (chunk, idx, totalChunks, callback) => {
        desenharTabela(chunk);
        setTimeout(() => {
          html2canvas(document.getElementById("tabela"), {scale: 3, backgroundColor: '#1e1e1e'}).then(canvas=>{
            let link=document.createElement("a");
            let n = idx+1;
            link.download=`doces_${n}_de_${totalChunks}.png`;
            link.href=canvas.toDataURL();
            link.click();
            if (callback) callback();
          });
        }, 150);
      };

      let chunks = [];
      for(let i=0; i<total; i+=chunkSize) {
        chunks.push(listaDoces.slice(i, i+chunkSize));
      }

      function baixarProximo(idx) {
        if(idx>=chunks.length) {
          desenharTabela();
          document.querySelector("#tabela thead").innerHTML = origTHead;
          return;
        }
        baixarChunk(chunks[idx], idx, chunks.length, ()=>baixarProximo(idx+1));
      }
      baixarProximo(0);
    }

    function baixarPNGUnico() {
      const tabela = document.getElementById("tabela");
      const origStyle = tabela.style.cssText;
      
      tabela.style.width = "auto";
      tabela.style.height = "auto";

      html2canvas(tabela, {
        scale: 2,
        scrollX: -window.scrollX,
        scrollY: -window.scrollY,
        windowWidth: document.documentElement.scrollWidth,
        windowHeight: document.documentElement.scrollHeight,
      }).then(canvas => {
        tabela.style.cssText = origStyle;
        const link = document.createElement('a');
        link.download = 'doces_unica.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      }).catch(err=>{
        tabela.style.cssText = origStyle;
        alert("‚ùå Erro ao gerar imagem: "+err);
      });
    }

    // PDF CORRIGIDO - COM LINHA FINAL E P√ÅGINA 2 FUNCIONANDO
    function exportarPDFPreenchido() {
      if (!listaDoces.length) {
        alert("A lista est√° vazia!");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageHeight = doc.internal.pageSize.getHeight();
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 10;
      const rowHeight = 6.5;
      const maxLinhasParPagina = 34;

      let colWidth = (pageWidth - 2 * margin) / (totalColunas + 2);
      let paginaAtual = 1;
      let indiceDoce = 0;

      function desenharCabecalho() {
        let yPos = margin;

        doc.setFont("Arial", "bold");
        doc.setFontSize(14);
        doc.text(`üç¨ Lista de Doces - ${listaAtual}`, margin, yPos);
        yPos += 8;

        doc.setFont("Arial", "normal");
        doc.setFontSize(8);
        doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')} | P√°gina ${paginaAtual}`, margin, yPos);
        yPos += 6;

        // Cabe√ßalho tabela
        doc.setFont("Arial", "bold");
        doc.setFontSize(10);
        doc.setFillColor(41, 128, 185);
        doc.setTextColor(255, 255, 255);
        doc.setDrawColor(41, 128, 185);
        doc.setLineWidth(0.5);

        doc.rect(margin, yPos, pageWidth - 2 * margin, 6, 'F');
        
        for(let i = 0; i <= totalColunas + 1; i++) {
          let x = margin + i * colWidth;
          doc.line(x, yPos, x, yPos + 6);
        }

        doc.text("#", margin + 2, yPos + 4);
        doc.text("üç¨ Doce", margin + colWidth + 2, yPos + 4);
        for (let i = 1; i <= totalColunas; i++) {
          doc.text(`Q${i}`, margin + (i + 1) * colWidth + 2, yPos + 4);
        }
        
        return yPos + 6;
      }

      let yPosition = desenharCabecalho();

      doc.setFont("Arial", "normal");
      doc.setFontSize(9);
      doc.setTextColor(0, 0, 0);
      doc.setDrawColor(150, 150, 150);
      doc.setLineWidth(0.3);

      let linhasNaPagina = 0;

      // Desenhar todas as linhas
      while(indiceDoce < listaDoces.length) {
        // Verificar se precisa nova p√°gina
        if(linhasNaPagina >= maxLinhasParPagina) {
          doc.addPage();
          paginaAtual++;
          yPosition = desenharCabecalho();
          linhasNaPagina = 0;
        }

        let doce_item = listaDoces[indiceDoce];

        // Linha horizontal superior
        doc.line(margin, yPosition, pageWidth - margin, yPosition);

        // Linhas verticais
        for(let i = 0; i <= totalColunas + 1; i++) {
          let x = margin + i * colWidth;
          doc.line(x, yPosition, x, yPosition + rowHeight);
        }

        // Conte√∫do
        doc.text((indiceDoce + 1).toString(), margin + 2, yPosition + 4);
        doc.text(doce_item.nome, margin + colWidth + 2, yPosition + 4);
        for (let c = 1; c <= totalColunas; c++) {
          doc.text(doce_item["Q" + c] || "", margin + (c + 1) * colWidth + 2, yPosition + 4);
        }
        
        yPosition += rowHeight;
        linhasNaPagina++;
        indiceDoce++;
      }

      // LINHA FINAL - IMPORTANTE!
      doc.line(margin, yPosition, pageWidth - margin, yPosition);
      for(let i = 0; i <= totalColunas + 1; i++) {
        let x = margin + i * colWidth;
        doc.line(x, yPosition, x, yPosition);
      }

      doc.save(`doces-${listaAtual}.pdf`);
      
      setTimeout(() => abrirPopup('infoPDF'), 500);
    }
  </script>
</body>
</html>
