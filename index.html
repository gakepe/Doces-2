<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor de Listas de Doces</title>
  <style>
    body { font-family: Arial,sans-serif; background:linear-gradient(135deg,#182848 0%,#2980b9 100%); color:#f0f0f0; margin:0; }
    #btnTopo { position:absolute; top:25px; left:50%; transform:translateX(-50%); z-index:3000; background:linear-gradient(90deg,#2196f3 0%,#64b5f6 100%); color:#fff; padding:18px 50px; font-size:22px; border:none; border-radius:10px; cursor:pointer; box-shadow:0 2px 12px #0005; font-weight:700; transition:background .2s,transform .1s; }
    #btnTopo:hover { background:linear-gradient(90deg,#1976d2 0%,#2980b9 100%); transform:translateX(-50%) scale(1.04);}
    #espacoVazio { height:3000px; width:100%; }
    #container { max-width:950px; margin:32px auto; background:rgba(30,30,30,0.92); border-radius: 12px; box-shadow:0 2px 20px #0005; padding: 26px; }
    h2 { text-align:center; color:#64b5f6; margin-top:0; }
    table { width:100%; border-collapse:collapse; background:#1e1e1e; margin-top:16px;}
    th,td { border:1px solid #333; padding:10px; text-align:center; min-width:80px; color:#f0f0f0;}
    th { background:#2980b9; color:#fff; font-weight:bold;}
    input, select, textarea { width:100%; padding:10px; font-size:16px; margin-bottom:10px; border:2px solid #64b5f6; border-radius:4px; background:#121212; color:white;}
    input:focus, select:focus, textarea:focus { border-color:#2980b9; outline:none;}
    button { background: linear-gradient(90deg,#2196f3 0%,#64b5f6 100%); color:#fff; padding:10px 22px; font-size:17px; border:none; border-radius:6px; cursor:pointer; margin-bottom:10px; font-weight:600; transition:background .2s,transform .1s}
    button:hover { background:linear-gradient(90deg,#1976d2 0%,#2980b9 100%);}
    .btn-group { text-align:center; margin-bottom:18px;}
    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#232a34; padding:22px 30px; border-radius:12px; box-shadow:0 0 18px #0008; z-index:2000; display:none; min-width:330px;}
    .popup input, .popup select { margin-bottom:8px;}
    .popup button { margin-right:6px; margin-bottom:0;}
    #overlay { position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;display:none;z-index:1999; }
    #aviso {max-width:900px; margin:24px auto 0 auto; padding:14px 22px; background:rgba(30,30,30,0.96); border-radius:10px; text-align:center; box-shadow:0 2px 10px #0003;}
    .red-btn { background: linear-gradient(135deg,#d32f2f 0%,#b71c1c 100%) !important; color: #fff !important; border: none; }
    .red-btn:hover { background: linear-gradient(135deg,#c62828 0%,#b71c1c 100%) !important;}
    .inline { display:inline-block; vertical-align:middle; }
    @media (max-width:650px){ #container{padding:10px;} .popup{min-width:97vw;} #aviso{padding:8px;}
      #btnTopo{font-size:18px; padding:14px 24px;}
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <button id="btnTopo">Ir para o site ‚ñº</button>
  <div id="espacoVazio"></div>
  <div id="aviso">
    <b>Bem-vindo!</b> Organize listas de doces, colunas, pesos e exporte/importe tudo. <br>
    N√£o recarregue o site sem salvar!
  </div>
  <div id="container">
    <div class="btn-group">
      <select id="listaSelect"></select>
      <button id="btnNovaLista">+ Nova Lista</button>
      <button id="btnRemoverLista">üóëÔ∏è Remover Lista</button>
      <button id="btnAddDoce">+ Adicionar Doce</button>
      <button id="btnRemDoce">üóëÔ∏è Remover Doce</button>
      <button id="btnEditDoce">‚úèÔ∏è Editar Nome</button>
      <button id="btnAddPeso">‚ûï Adicionar Peso</button>
      <button id="btnColunas">Colunas</button>
      <button id="btnExportar">üíæ Exportar</button>
      <button id="btnImportar">üì• Importar</button>
      <input id="importar" type="file" accept=".json" style="display:none">
      <button id="btnPNG">üì∑ PNG</button>
      <button id="btnApagarTudo">üßπ Apagar tudo</button>
      <select id="ordenacaoSelect">
        <option value="alfabetica">Alfab√©tica</option>
        <option value="pesoAsc">Peso crescente</option>
        <option value="pesoDesc">Peso decrescente</option>
      </select>
    </div>
    <table id="tabela">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="overlay"></div>

  <!-- POPUP ADICIONAR DOCE -->
  <div class="popup" id="popup-addDoce">
    <h3>Novo doce</h3>
    <input type="text" id="novoDoce" placeholder="Nome do doce">
    <button id="popupAddDoceBtn">Adicionar</button>
    <button class="popupCancelBtn">Cancelar</button>
  </div>
  <!-- POPUP REMOVER DOCE -->
  <div class="popup" id="popup-remDoce">
    <h3>Remover doce</h3>
    <select id="selRemover"></select>
    <button id="popupRemDoceBtn">Remover</button>
    <button class="popupCancelBtn">Cancelar</button>
  </div>
  <!-- POPUP EDITAR DOCE -->
  <div class="popup" id="popup-editDoce">
    <h3>Editar nome</h3>
    <select id="selEditDoce"></select>
    <input type="text" id="novoNomeEdit" placeholder="Novo nome">
    <button id="popupEditDoceBtn">Salvar</button>
    <button class="popupCancelBtn">Cancelar</button>
  </div>
  <!-- POPUP ADICIONAR PESO -->
  <div class="popup" id="popup-addPeso">
    <h3>Adicionar peso</h3>
    <input type="text" id="buscaPeso" placeholder="Buscar doce...">
    <select id="selPesoDoce"></select>
    <select id="selPesoCol"></select>
    <input type="text" id="pesoNovo" maxlength="7" placeholder="Peso (ex: 0.250)">
    <div style="margin-bottom:8px;">
      <button id="btnAddPesoPopup" class="inline">Adicionar Peso</button>
      <button id="btnDesbloqueia" class="red-btn inline" style="display:none;">X</button>
      <button id="btnSomarPeso" class="inline">Somar Peso</button>
      <button id="btnLimparPeso" class="inline">Limpar Peso</button>
      <button id="btnLimparTodosPesos" class="red-btn inline">Limpar Todos os Pesos</button>
    </div>
    <button class="popupCancelBtn">Cancelar</button>
  </div>
  <!-- POPUP COLUNAS -->
  <div class="popup" id="popup-colunas">
    <h3>Colunas</h3>
    <button id="btnNovaColuna">+ Nova coluna</button>
    <select id="selRemCol"></select>
    <button id="btnRemColuna">Remover coluna</button>
    <button class="popupCancelBtn">Fechar</button>
  </div>

<script>
let todasListas={}, listaAtual="Principal", listaDoces=[], totalColunas=1;
let pesoBloqueado = false;

document.addEventListener("DOMContentLoaded",()=>{
  // Bot√£o "Ir para o site" fixo no topo
  document.getElementById("btnTopo").onclick = function() {
    document.getElementById("container").scrollIntoView({behavior:"smooth"});
  };

  // Inicializa√ß√£o
  carregarTodasListas();
  desenharTabela();

  // Popups Cancelar
  document.querySelectorAll('.popupCancelBtn').forEach(btn=>{
    btn.onclick = fecharPopup;
  });

  // Bot√µes principais
  document.getElementById("btnNovaLista").onclick = novaLista;
  document.getElementById("btnRemoverLista").onclick = removerLista;
  document.getElementById("listaSelect").onchange = trocarLista;
  document.getElementById("btnAddDoce").onclick = ()=>abrirPopup('addDoce');
  document.getElementById("btnRemDoce").onclick = ()=>abrirPopup('remDoce');
  document.getElementById("btnEditDoce").onclick = ()=>abrirPopup('editDoce');
  document.getElementById("btnAddPeso").onclick = ()=>abrirPopup('addPeso');
  document.getElementById("btnColunas").onclick = ()=>abrirPopup('colunas');
  document.getElementById("btnExportar").onclick = confirmarExportar;
  document.getElementById("btnImportar").onclick = confirmarImportar;
  document.getElementById("importar").onchange = importar;
  document.getElementById("btnPNG").onclick = baixarPNGVarios;
  document.getElementById("btnApagarTudo").onclick = apagarTudo;
  document.getElementById("ordenacaoSelect").onchange = ordenarLista;

  // Popup Adicionar Doce
  document.getElementById("popupAddDoceBtn").onclick = addDoce;
  // Popup Remover Doce
  document.getElementById("popupRemDoceBtn").onclick = remDoce;
  // Popup Editar Doce
  document.getElementById("popupEditDoceBtn").onclick = editDoce;
  // Popup Adicionar Peso
  document.getElementById("btnAddPesoPopup").onclick = addPeso;
  document.getElementById("btnDesbloqueia").onclick = desbloquearPeso;
  document.getElementById("btnSomarPeso").onclick = somarPeso;
  document.getElementById("btnLimparPeso").onclick = limparPeso;
  document.getElementById("btnLimparTodosPesos").onclick = limparTodosPesosColuna;
  document.getElementById("buscaPeso").addEventListener('input', filtrarDropdownPeso);

  // Ponto autom√°tico no campo peso
  document.getElementById('pesoNovo').addEventListener('input', function(e){
    let v = this.value;
    if (v.length === 1 && /\d/.test(v) && !v.includes('.')) {
      this.value = v + '.';
      this.setSelectionRange(this.value.length, this.value.length);
    }
  });

  // Popups de colunas
  document.getElementById("btnNovaColuna").onclick = novaColuna;
  document.getElementById("btnRemColuna").onclick = remColuna;

  // Overlay fecha popup ao clicar fora
  document.getElementById('overlay').onclick = fecharPopup;
});

// LISTAS
function novaLista() {
  let nome = prompt("Nome da nova lista?");
  if(!nome || todasListas[nome]) return alert("Nome j√° existe ou inv√°lido!");
  todasListas[nome]={listaDoces:[],totalColunas:1}; listaAtual=nome;
  carregarListaAtual(); atualizarListaSelect(); salvarTodasListas();
}
function removerLista() {
  if(listaAtual==="Principal") return alert("N√£o pode remover Principal!");
  if(!confirm("Tem certeza?")) return;
  delete todasListas[listaAtual]; listaAtual="Principal";
  carregarListaAtual(); atualizarListaSelect(); salvarTodasListas();
}
function trocarLista() {
  listaAtual = document.getElementById("listaSelect").value;
  carregarListaAtual(); desenharTabela();
}
function atualizarListaSelect() {
  let sel = document.getElementById("listaSelect"); sel.innerHTML="";
  Object.keys(todasListas).forEach(nome=>{
    let opt=document.createElement("option");
    opt.value=opt.text=nome; sel.appendChild(opt);
  }); sel.value=listaAtual;
}

// LOCALSTORAGE
function salvarTodasListas() {
  todasListas[listaAtual]={listaDoces,totalColunas};
  localStorage.setItem("todasListas",JSON.stringify(todasListas));
}
function carregarTodasListas() {
  try {
    todasListas=JSON.parse(localStorage.getItem("todasListas"))||{"Principal":{listaDoces:[],totalColunas:1}};
  }catch{ todasListas={"Principal":{listaDoces:[],totalColunas:1}}; }
  listaAtual=Object.keys(todasListas)[0];
  carregarListaAtual(); atualizarListaSelect();
}
function carregarListaAtual() {
  let dados = todasListas[listaAtual];
  listaDoces = dados.listaDoces; totalColunas = dados.totalColunas||1;
  desenharTabela(); salvarTodasListas();
}
  // TABELA E DROPDOWNS
function desenharTabela(subset=null) {
  // subset: array de doces para renderizar, ou null para todos
  let docesParaDesenhar = subset || listaDoces;
  // Cabe√ßalho
  let ths = `<tr><th>#</th><th>Doce</th>`;
  for(let i=1;i<=totalColunas;i++) ths+=`<th>Q${i}</th>`;
  ths+=`</tr>`;
  document.querySelector("#tabela thead").innerHTML = ths;
  // Corpo
  let tds = '';
    docesParaDesenhar.forEach((doc,i)=>{
    tds+=`<tr><td>${i+1}</td><td>${doc.nome}</td>`;
    for(let c=1;c<=totalColunas;c++) tds+=`<td>${doc["Q"+c]||""}</td>`;
    tds+=`</tr>`;
  });
  document.querySelector("#tabela tbody").innerHTML = tds;
}

// POPUPS
function abrirPopup(tipo) {
  document.getElementById('overlay').style.display='block';
  document.querySelectorAll('.popup').forEach(p=>p.style.display='none');
  document.getElementById('popup-'+tipo).style.display='block';

  if(tipo==='remDoce') montarSelRemover();
  if(tipo==='editDoce') montarSelEditDoce();
  if(tipo==='addPeso') montarSelPeso();
  if(tipo==='colunas') montarSelColuna();

  // Fun√ß√£o "errado" ao abrir popup de peso
  if(tipo==='addPeso') {
    pesoBloqueado = false;
    document.getElementById('btnAddPesoPopup').disabled = false;
    document.getElementById('btnDesbloqueia').style.display = 'none';
    let sel = document.getElementById('selPesoDoce');
    let erradoOpt = document.createElement('option');
    erradoOpt.value = erradoOpt.text = 'errado';
    sel.insertBefore(erradoOpt, sel.firstChild);
    sel.value = 'errado';
    document.getElementById('buscaPeso').value = '';
    filtrarDropdownPeso();
  }
}
function fecharPopup() {
  document.getElementById('overlay').style.display='none';
  document.querySelectorAll('.popup').forEach(p=>p.style.display='none');
}

// DOCES
function addDoce() {
  let nome = document.getElementById('novoDoce').value.trim();
  if(!nome) return alert("Nome vazio!");
  if(listaDoces.some(d=>d.nome.toLowerCase()===nome.toLowerCase())) return alert("Doce j√° existe!");
  let novo = {nome};
  for(let i=1;i<=totalColunas;i++) novo["Q"+i]="";
  listaDoces.push(novo);
  desenharTabela();
  fecharPopup();
  salvarTodasListas();
  document.getElementById('novoDoce').value="";
}
function montarSelRemover() {
  let sel = document.getElementById('selRemover'); sel.innerHTML='';
  listaDoces.forEach(d=>{
    let opt=document.createElement('option');
    opt.value=opt.text=d.nome; sel.appendChild(opt);
  });
}
function remDoce() {
  let nome = document.getElementById('selRemover').value;
  listaDoces = listaDoces.filter(d=>d.nome!==nome);
  desenharTabela(); fecharPopup(); salvarTodasListas();
}
function montarSelEditDoce() {
  let sel = document.getElementById('selEditDoce'); sel.innerHTML='';
  listaDoces.forEach(d=>{
    let opt=document.createElement('option');
    opt.value=opt.text=d.nome; sel.appendChild(opt);
  });
  document.getElementById('novoNomeEdit').value="";
}
function editDoce() {
  let nomeSel = document.getElementById('selEditDoce').value;
  let novoNome = document.getElementById('novoNomeEdit').value.trim();
  if(!novoNome) return alert("Nome vazio!");
  if(listaDoces.some(d=>d.nome.toLowerCase()===novoNome.toLowerCase())) return alert("J√° existe um doce com esse nome!");
  listaDoces.find(d=>d.nome===nomeSel).nome=novoNome;
  desenharTabela(); fecharPopup(); salvarTodasListas();
}

// PESOS ‚Äî BUSCA
function filtrarDropdownPeso() {
  let termo = document.getElementById('buscaPeso').value.toLowerCase();
  let sel = document.getElementById('selPesoDoce');
  for(let i=0;i<sel.options.length;i++) {
    let opt = sel.options[i];
    opt.style.display = opt.text.toLowerCase().includes(termo) ? "block" : "none";
  }
  let visiveis = [...sel.options].filter(o=>o.style.display=="block");
  if(visiveis.length) sel.value = visiveis[0].value;
  else sel.value = "errado";
}

// PESOS ‚Äî FUN√á√ïES
function montarSelPeso() {
  let selD = document.getElementById('selPesoDoce');
  let selC = document.getElementById('selPesoCol');
  selD.innerHTML = ''; selC.innerHTML = '';
  listaDoces.forEach(d=>{
    let opt=document.createElement('option');
    opt.value=opt.text=d.nome; selD.appendChild(opt);
  });
  for(let i=1;i<=totalColunas;i++){
    let opt=document.createElement('option');
    opt.value=opt.text="Q"+i; selC.appendChild(opt);
  }
}
function addPeso() {
  let doce = document.getElementById('selPesoDoce').value;
  let coluna = document.getElementById('selPesoCol').value;
  let valor = document.getElementById('pesoNovo').value.trim();
  if(doce==='errado') {
    alert("Voc√™ tentou adicionar peso ao item 'errado'. O bot√£o est√° bloqueado. Clique no X vermelho para desbloquear.");
    pesoBloqueado = true;
    document.getElementById('btnAddPesoPopup').disabled = true;
    document.getElementById('btnDesbloqueia').style.display = 'inline-block';
    return;
  }
  if(!valor.match(/^\d+(\.\d{1,3})?$/)) return alert("Peso inv√°lido!");
  let doceObj = listaDoces.find(d=>d.nome===doce);
  if(doceObj[coluna]) if(!confirm(`J√° existe valor (${doceObj[coluna]}) nessa coluna. Substituir?`)) return;
  doceObj[coluna]=valor.padEnd(5,"0");
  desenharTabela(); fecharPopup(); salvarTodasListas();
  document.getElementById('pesoNovo').value="";
}

function desbloquearPeso() {
  pesoBloqueado = false;
  document.getElementById('btnAddPesoPopup').disabled = false;
  document.getElementById('btnDesbloqueia').style.display = 'none';
  document.getElementById('selPesoDoce').value = 'errado';
}

function somarPeso() {
  let doce = document.getElementById('selPesoDoce').value;
  let coluna = document.getElementById('selPesoCol').value;
  let valor = document.getElementById('pesoNovo').value.trim();
  if(doce==='errado') return alert("N√£o √© poss√≠vel somar peso ao item 'errado'.");
  let doceObj = listaDoces.find(d=>d.nome===doce);
  if(!doceObj[coluna]) return alert("Esse doce n√£o possui peso definido nessa coluna para somar.");
  if(!valor.match(/^\d+(\.\d{1,3})?$/)) return alert("Peso inv√°lido!");
  if(!confirm(`Peso atual: ${doceObj[coluna]}\nDeseja somar ${valor} ao peso atual?`)) return;
  let soma = parseFloat(doceObj[coluna]) + parseFloat(valor);
  doceObj[coluna] = soma.toFixed(3);
  desenharTabela(); fecharPopup(); salvarTodasListas();
  document.getElementById('pesoNovo').value="";
}

function limparPeso() {
  let doce = document.getElementById('selPesoDoce').value;
  let coluna = document.getElementById('selPesoCol').value;
  if(doce==='errado') return alert("N√£o √© poss√≠vel limpar peso do item 'errado'.");
  let doceObj = listaDoces.find(d=>d.nome===doce);
  if(!doceObj[coluna]) return alert("Esse doce j√° est√° sem peso nessa coluna.");
  if(!confirm("Deseja realmente limpar o peso desse doce na coluna selecionada?")) return;
  doceObj[coluna] = "";
  desenharTabela(); fecharPopup(); salvarTodasListas();
}

// NOVO: Limpar todos os pesos da coluna selecionada
function limparTodosPesosColuna() {
  let coluna = document.getElementById('selPesoCol').value;
  if(!coluna) return alert("Selecione a coluna!");
  if(!confirm("Isso vai remover TODOS os pesos dos doces da coluna " + coluna + ". Tem certeza?")) return;
  listaDoces.forEach(doc=>doc[coluna]="");
  desenharTabela(); salvarTodasListas();
  alert("Todos os pesos da coluna " + coluna + " foram limpos.");
}

// COLUNAS
function montarSelColuna() {
  let sel = document.getElementById('selRemCol'); sel.innerHTML = '';
  for(let i=1;i<=totalColunas;i++){
    let opt=document.createElement('option');
    opt.value=opt.text="Q"+i; sel.appendChild(opt);
  }
}
function novaColuna() {
  totalColunas++;
  listaDoces.forEach(d=>d["Q"+totalColunas]="");
  desenharTabela(); montarSelColuna(); salvarTodasListas();
}
function remColuna() {
  let col = document.getElementById('selRemCol').value;
  listaDoces.forEach(d=>delete d[col]);
  totalColunas--;
  desenharTabela(); montarSelColuna(); salvarTodasListas();
}

// EXPORTAR/IMPORTAR
function confirmarExportar() {
  if(!confirm("Deseja exportar os dados da lista atual?")) return;
  salvar();
}
function salvar() {
  let blob=new Blob([JSON.stringify({listaDoces,totalColunas},null,2)],{type:"application/json"});
  let link=document.createElement("a");
  link.href=URL.createObjectURL(blob); link.download="lista-doces.json"; link.click();
}
function confirmarImportar() {
  if(!confirm("Deseja importar uma lista (isso ir√° substituir a atual)?")) return;
  document.getElementById('importar').click();
}
function importar(e) {
  let file = e.target.files[0];
  if(!file) return;
  let reader=new FileReader();
  reader.onload=()=>{
    try{
      let dados=JSON.parse(reader.result);
      if(!dados.listaDoces||!Array.isArray(dados.listaDoces)) throw "Formato inv√°lido";
      listaDoces=dados.listaDoces; totalColunas=dados.totalColunas||1;
      desenharTabela(); salvarTodasListas();
      alert("Importado!");
    }catch{ alert("Erro ao importar. Arquivo inv√°lido."); }
  };
  reader.readAsText(file);
}

// APAGAR TUDO
function apagarTudo() {
  if(!confirm("Isso apagar√° toda a lista!")) return;
  listaDoces=[]; totalColunas=1;
  desenharTabela(); salvarTodasListas();
}

// ORDENAR
function ordenarLista() {
  const modo = document.getElementById("ordenacaoSelect").value;
  let coluna = "Q1";
  if (modo === "alfabetica") {
    listaDoces.sort((a,b)=>a.nome.localeCompare(b.nome));
  } else if (modo === "pesoAsc") {
    listaDoces.sort((a,b)=>{
      let pa = parseFloat(a[coluna]);
      let pb = parseFloat(b[coluna]);
      if(isNaN(pa))pa=Infinity;if(isNaN(pb))pb=Infinity;
      if(pa===pb)return a.nome.localeCompare(b.nome);
      return pa-pb;
    });
  } else if (modo === "pesoDesc") {
    listaDoces.sort((a,b)=>{
      let pa = parseFloat(a[coluna]);
      let pb = parseFloat(b[coluna]);
      if(isNaN(pa))pa=-Infinity;if(isNaN(pb))pb=-Infinity;
      if(pa===pb)return a.nome.localeCompare(b.nome);
      return pb-pa;
    });
  }
  desenharTabela();
}

// PNG
// NOVO: Baixar v√°rias imagens de at√© 20 linhas cada
function baixarPNGVarios() {
  if (!listaDoces.length) {
    alert("A lista est√° vazia!");
    return;
  }
  const total = listaDoces.length;
  const chunkSize = 20;
  let origTHead = document.querySelector("#tabela thead").innerHTML;

  let baixarChunk = (chunk, idx, totalChunks, callback) => {
    desenharTabela(chunk);
    setTimeout(() => {
      html2canvas(document.getElementById("tabela")).then(canvas=>{
        let link=document.createElement("a");
        let n = idx+1;
        link.download=`lista_${n}de${totalChunks}.png`;
        link.href=canvas.toDataURL();
        link.click();
        if (callback) callback();
      });
    }, 150); // aguarda renderiza√ß√£o
  };

  let chunks = [];
  for(let i=0; i<total; i+=chunkSize) {
    chunks.push(listaDoces.slice(i, i+chunkSize));
  }

  function baixarProximo(idx) {
    if(idx>=chunks.length) {
      desenharTabela(); // restaura tabela completa ap√≥s exportar
      document.querySelector("#tabela thead").innerHTML = origTHead;
      return;
    }
    baixarChunk(chunks[idx], idx, chunks.length, ()=>baixarProximo(idx+1));
  }
  baixarProximo(0);
}

</script>
</body>
</html>